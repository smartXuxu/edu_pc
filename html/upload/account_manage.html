<!DOCTYPE html>
<html>
<head lang="en">
    <link rel="shortcut icon " type="images/x-icon" href="../../ico.ico">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>账号 管理</title>
    <!-- Bootstrap -->
    <link href="../../css/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link href="../../css/iconfont.css" rel="stylesheet">
    <link href="../../css/upload/upload.css" rel="stylesheet">
    <link href="../../css/upload/auth.css" rel="stylesheet">
    <link href="../../css/sweetalert2.css" rel="stylesheet">
    <link href="../../css/upload/account_manage.css" rel="stylesheet">
    <style>
        .quit_login{
            width: 200px;
            display: block;
            height: 31px;
            line-height: 31px;
            -webkit-border-radius: 5px;
            -moz-border-radius: 5px;
            border-radius: 5px;
            text-align: center;
            color:#fff;
            font-size: 14px;
            margin-top: 10px;
            background-color:#f01414;
        }
    </style>
</head>
<body>
<div class="layer">
    <div class="header"></div>

    <div class="left"></div>
    <div class="content">
        <div class="account_right">
            <div class="account_top">
                <nav>
                    <a href="javascript:;" class="active menu">基本信息</a>
                    <!--<a href="javascript:;" class="menu">身份信息</a>-->
                    <a href="javascript:;" class="menu">账号设置</a>
                </nav>
            </div>
            <div class="content_middle base_info">
                <div class="head">
                    <!--更换头像-->
                    <h5>头像</h5>
                    <img src="../../img/logo%20(2).png" alt=""/>
                    <span>想更换头像吗，赶快去下载猴姆教学APP吧！</span>
                </div>
                <div class="nick_name">
                    <em>昵称：</em>
                    <input type="text" placeholder="请输入昵称"/>
                    <!--<i class="iconfont icon-zhuyi"> 昵称不能为空</i>-->

                </div>
                <div class="sex">
                    <em>性别：</em>
                    <from>
                        <input type="radio" name="sex" value="男" checked/> 男
                        <input type="radio" name="sex" value="女"/> 女
                    </from>
                </div>
                <div class="birthday">
                    <em>生日： </em>
                    <input type="date" placeholder="请选择您的生日"/>
                    <!--<input type="datetime-local" placeholder="请选择您的生日"/>-->
                </div>
                <div class="city">
                    <em>所在地区：</em>
                    <span class="info">
                            <select id="s_province" name="s_province"></select>  
                            <select id="s_city" name="s_city" ></select>  
                            <select id="s_county" name="s_county"></select>
                        </span>

                    <div id="show"></div>
                </div>
                <button class="save basic "id="basic"> 保存</button>
            </div>
            <!--<div class="content_middle id_menu">
                <div class="min_identity">
                    <span>我的身份</span>
                    <em>学生</em>
                </div>
                <div class="min_grade">
                    <span>我的年级</span>
                    <select id="select_id">
                        <option value ="volvo">高三</option>
                        <option value ="saab">高二</option>
                        <option value="opel">高一</option>
                        <option value="audi">初三</option>
                        <option value="audi">初二</option>
                        <option value="audi">初一</option>
                        <option value="audi">六年级</option>
                        <option value="audi">五年级</option>
                        <option value="audi">四年级</option>
                        <option value="audi">三年级</option>
                        <option value="audi">二年级</option>
                        <option value="audi">一年级</option>
                    </select>
                </div>
                <div class="min_school">
                    <span>我的学校</span>
                    <input type="text" placeholder="请输入您的学校"/>
                </div>

                <button class="save">保存</button>
            </div>-->

            <div class="content_middle account_info">
                <div id="mask"></div>
                <div id="link_share">
                    <p>绑定邮箱</p>
                    <div class="email_account">
                        <span>邮箱账号：</span>
                        <input type="email" class="emails" placeholder="请输入邮箱账号"/>
                    </div>
                    <div class="email_account">
                        <span class="email_code">获取邮箱验证码</span>
                        <input type="email" class="codes" placeholder="请填写验证码"/>
                    </div>
                    <!-- Indicates a dangerous or potentially negative action -->
                    <button type="button" class="btn btn-danger  btn-lg confirm">确定</button>
                </div>
                <!--<div class="pnone">
                    <em>手机</em>
                    <span>135****123</span>
                </div>-->
                <div class="email">
                    <em>绑定邮箱</em>
                    <span class="no_link">未绑定</span>
                </div>
                <div class="change_password">
                    <p>修改密码</p>
                    <input type="password" placeholder="请输入原始密码"/>
                    <input type="password" placeholder="请输入新密码"/>
                </div>
                <button class="save ch_pas">保存</button>
                <button class="quit_login">退出登录</button>
            </div>
        </div>
    </div>

    <div class="footer"></div>
</div>


</body>
<!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
<!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
<!--[if lt IE 9]>
<script src="../../js/bootstrap/html5shiv.main.js"></script>
<script src="../../js/bootstrap/respond.min.js"></script>
<![endif]-->
<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
<script src="../../js/jquery.min.js"></script>
<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
<script src="../../js/bootstrap/bootstrap.min.js"></script>
<script src="../../js/base.js"></script>
<script src="../../js/sweetalert2.js"></script>
<script src="../../js/origin_city/area.js"></script>

<script>
    var flag=true;
    var userid=localStorage.getItem("this_userid");
    $(function () {
        $(".header").load("../common/header_logo.html");
        $(".left").load("../common/mine_index.html");
        $(".footer").load("../common/footer.html");
        setTimeout(function () {
            $(".left_middle>a:nth-of-type(4)").addClass("active");
        },100)
    })
    //头像显示
    if(localStorage.getItem("this_pic")){
        $(".content_middle.base_info>.head>img").attr("src",localStorage.getItem("this_pic"))
    }else{
        // logo%20(2).png
        $(".content_middle.base_info>.head>img").attr("src",'logo%20(2).png')
    }
    //点击退出登录
    $(".quit_login").click(function () {
        console.log(123);
        var token=localStorage.getItem("token");
        render(token);
    })

    function render(token){
        $.ajax({
            //处理session每次不唯一问题
            xhrFields: {
                withCredentials: true
            },
            type: "post",
            url: baseUrl+"/user/logout",
            data:{token:token},
            dataType: 'json',
            success:function(data) {
                console.log(data);
                if(data.status==200){
                    localStorage.removeItem("pwd");
                    location.href='../common/login.html';
                }
            }

        })
    }
    //table 栏的切换
    $(".menu").click(function () {
        //jQuery index的属性
        var index=$(this).index();
        console.log(index);
        $(this).addClass("active").siblings().removeClass("active");
        $('.content_middle').eq(index).show().siblings(".content_middle").hide();
    })
    //基本信息
    var obj={};
    obj.userid=localStorage.getItem("this_userid");
    obj.token=localStorage.getItem("token");
    obj.identityAuthentication=localStorage.getItem("identityAuthentication");
    $(".base_info #basic").click(function(){
        var this_pic=localStorage.getItem('this_pic');
        console.log(this_pic);
        //头像
        obj.portrait=this_pic;
        //昵称
        var nickname=$(".nick_name>input").val().trim();
        if(nickname.length==0){
            sweetAlert(
                    "sorry",
                    "昵称不能为空哦",
                    "error"
            )
            return false;
        }else{
            obj.nickname=nickname;
        }
        //性别
        obj.sex=$(".sex input[name='sex']:checked").val();
        //生日
        var birthday=$(".birthday>input").val()
        if(birthday==""){
            sweetAlert(
                    "对不起",
                    "请您选择生日",
                    "error"
            )
        }else{
            obj.date=birthday.replace(/-/g,"");
        }
        //地址
        var province=$("#s_province").find("option:selected").text();//省
        var city=$("#s_city").find("option:selected").text();//市
        var county=$("#s_county").find("option:selected").text();//区
        if(province=="省份"||city=="地级市"){
            sweetAlert(
                    "sorry",
                    "地址不能为空哦",
                    "error"
            )
            return false;
        }else{
            obj.address=province+city+county;
        }
        myAjax({url:"/user/modify/personal",data:obj,type:"post"}, function (data) {
            console.log(data);
            if(data.status==200){
                sweetAlert(
                        "恭喜您",
                        "个人资料修改成功了",
                        "success"
                )
            }else{
                sweetAlert(
                        "sorry",
                        data.msg,
                        "error"
                )
            }
        })
    })
    myAjax({url:"/sundry/get/EmailBind/Status",type:"post",data:{userid:userid}}, function (data) {
        console.log(data);
        if(data.status==200){
            if(data.data.status==false){
                $(".email").html(`<em>绑定邮箱</em>
                <span class="no_link bindingk">未绑定</span>`)
            }else{
                $(".email").html(`<em>绑定邮箱</em>
                <span class="no_link">已绑定</span>`);
            }
        }
    })
    /*绑定邮箱 */
    $(".email").on("click",".bindingk",function (e) {
        $("#mask").show();
        $("#link_share").show();
        console.log(e);

        $(".email_code").click(function(){//验证码
            var ind=$(this);
            if(flag){
                var str=$(".emails").val().trim();
                getCode(str,ind);
            }
        })
        $(".confirm").click(function () {
            var code=$(".codes").val().trim();
            if(code.length==0){
                sweetAlert(
                        "sorry",
                        "请您填写邮箱验证码",
                        "error"
                )
            }else{
                myAjax({url:"/sundry/update/Email/Binding",data:{userid:userid,code:code,email:$(".emails").val().trim()},type:"post"}, function (data) {
                    console.log(data);
                    if(data.status==200){
                        $(".finish").text("已绑定")
                    }else{
                        sweetAlert(
                                "sorry",
                                data.msg,
                                "error"
                        )
                    }
                    $("#link_share").hide();
                })
            }
        })
    })


    function getCode(str,ind){
        // 先验证 用户输入的邮箱 不正确 阻断 返回
        var re = /^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/;
        if(!re.test(str)){
            sweetAlert(
                    "sorry",
                    "对不起，请您输入正确的邮箱",
                    "error"
            ).then(function () {
                        $("input").val("");
                    })
            return false;
        }else{
            myAjax({url:"/sundry/add/Email/authcode",data:{userid:userid,email:str},type:"post"}, function (data) {
                console.log(data);
                if(data.code==200){
                    sweetAlert(
                            "验证码已发送，请您查收输入",
                            "success"
                    )
                }
            })
        }
        flag=false;
        //倒计时效果
        var time=300;
        ind.text(time+ "S");
        var timer= setInterval(function(){
            time--;
            $(".getCode").text(time+ "S");
            if(time<0){
                clearInterval(timer);
                $(".getCode").text("重新发送");
                $(".email>input").val("");
                time=300;
                flag=true;
            }
        },1000)
    }
    $("#mask").click(function (e) {
        if(e.target!=$("#link_share")){
            $("#mask").hide();
            $("#link_share").hide();
        }
    })
    //密码修改
    $(".ch_pas").click(function(){

        var pass1=$(".change_password>input:eq(0)").val();
        var pass2=$(".change_password>input:eq(1)").val();
        console.log(pass1);
        console.log(pass2);
    })

    $(".ch_pas").click(function(){
        var regu = "^[0-9a-zA-Z]{6,12}$";
        var re = new RegExp(regu);
        var parm={};


        //发送ajax
        var Npassword=$(".change_password>input:eq(1)").val();//新密码
        parm.newPassword =Npassword;
        parm.mobile=localStorage.getItem("uName");
        var Opassword=$(".change_password>input:eq(0)").val();//旧密码
        parm.oldPassword=Opassword;
        if (re.test(Npassword)&&re.test(Opassword)) {
            $.ajax({
                xhrFields: {
                    withCredentials: true
                },
                type:"post",
                dataType: 'json',
                url:baseUrl+"/user/update/password",
                data: parm,
                success: function (data) {
                    console.log(data);
                    if(data.status==200){
                        sweetAlert(
                                "恭喜您",
                                "密码修改成功啦",
                                "success"
                        ).then(function () {
                                    window.location.href="../common/login.html";
                                })

                    }else{
                        sweetAlert(
                                "sorry",
                                data.msg,
                                "error"
                        )
                    }
                },
                error: function () {
                    sweetAlert(
                            "sorry",
                            data.msg,
                            "error"
                    )
                }
            })
        }
        else{
            sweetAlert(
                    "sorry",
                    "密码格式不正确喔",
                    "error"
            ).then(function () {
                        $("input").val("");
                    })
            return false;
        }
    });
    //三级联动的城市调用
    _init_area();
    var Gid  = document.getElementById ;

    var showArea = function(){

        Gid('show').innerHTML = "<h3>省" + Gid('s_province').value + " - 市" +

                Gid('s_city').value + " - 县/区" +

                Gid('s_county').value + "</h3>"

    }
    Gid('s_county').setAttribute('onchange','showArea()');

    /* jQuery获取Select选择的Text和Value:


     语法解释：
     1. $("#select_id").change(function(){//code...});   //为Select添加事件，当选择其中一项时触发
     2. var checkText=$("#select_id").find("option:selected").text();  //获取Select选择的Text
     3. var checkValue=$("#select_id").val();  //获取Select选择的Value
     4. var checkIndex=$("#select_id ").get(0).selectedIndex;  //获取Select选择的索引值
     5. var maxIndex=$("#select_id option:last").attr("index");  //获取Select最大的索引值*/

    var checkText=$("#select_id").find("option:selected").text();
    console.log(checkText);

</script>
</html>